<!DOCTYPE html>
<html lang="ku" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>WOTUBE | Infinite Scroll Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --bg-color-light: #F5F5F5; --text-color-light: #111111;
      --card-bg-light: #FFFFFF; --line-color-light: #E0E0E0;
      --bg-color-dark: #121212; --text-color-dark: #EAEAEA;
      --card-bg-dark: #1E1E1E; --line-color-dark: #333333;
      --accent-red: #FF3B30; --transition-speed: 0.4s;
    }
    [data-theme="light"] {
        --bg-color: var(--bg-color-light); --text-color: var(--text-color-light);
        --card-bg: var(--card-bg-light); --line-color: var(--line-color-light);
    }
    [data-theme="dark"] {
        --bg-color: var(--bg-color-dark); --text-color: var(--text-color-dark);
        --card-bg: var(--card-bg-dark); --line-color: var(--line-color-dark);
    }
    body {
      font-family: 'Montserrat', sans-serif; background-color: var(--bg-color);
      color: var(--text-color); margin: 0; padding: 24px; overflow-x: hidden;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    .content-wrapper { max-width: 600px; margin: 0 auto; }
    header { padding: 20px 0; display: flex; justify-content: space-between; align-items: center; }
    #logo { font-size: 2.5rem; font-weight: 900; letter-spacing: -2px; }
    #logo span { color: var(--accent-red); }
    #theme-switcher { font-size: 1.5rem; cursor: pointer; padding: 10px; }
    #theme-switcher .fa-moon { display: none; }
    [data-theme='dark'] .fa-sun { display: none; }
    [data-theme='dark'] .fa-moon { display: inline-block; }
    #searchSection { margin-bottom: 30px; }
    .search-input-wrapper {
        border: 3px solid var(--text-color); background-color: var(--card-bg);
        display: flex; padding: 5px; transition: border-color var(--transition-speed);
    }
    #searchQuery { flex-grow: 1; border: none; outline: none; background: transparent; color: var(--text-color); font-size: 1.1rem; font-weight: 700; padding: 15px; }
    #searchBtn {
        min-width: 110px; padding: 15px; background-color: var(--text-color);
        border: none; color: var(--bg-color); font-family: 'Montserrat', sans-serif;
        font-weight: 700; font-size: 1.1rem; cursor: pointer;
        transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #searchBtn:hover { background-color: var(--accent-red); color: #fff; }
    #results { display: grid; grid-template-columns: 1fr; gap: 20px; padding-bottom: 40px; }
    .video-card { background-color: var(--card-bg); animation: popIn 0.5s ease-out backwards; }
    .video-card iframe { width: 100%; height: 200px; border: none; display: block; }
    .video-card-content { padding: 15px; }
    .video-card h4 { margin: 0 0 10px 0; font-weight: 700; font-size: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .video-info { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.7; }
    .message { text-align: center; padding: 40px 20px; font-size: 1.5rem; font-weight: 700; }
    .loader { width: 100%; height: 5px; background-color: var(--line-color); position: relative; overflow: hidden; margin: 60px auto 0 auto; }
    .loader.bottom-loader { margin: 20px auto 40px auto; } /* Style for infinite scroll loader */
    .loader::before { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background-color: var(--accent-red); animation: loader-anim 1.5s infinite; }
    footer { text-align: center; padding: 30px 0; border-top: 2px solid var(--line-color); margin-top: 20px; font-weight: 700; }
    @keyframes popIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes loader-anim { 0% { left: -50%; width: 50%; } 50% { left: 50%; width: 50%; } 100% { left: 100%; width: 0; } }
  </style>
</head>
<body>
  <div class="content-wrapper">
      <header>
        <h1 id="logo">WO<span>TUBE</span></h1>
        <div id="theme-switcher" title="Theme Switcher"> <i class="fas fa-sun"></i><i class="fas fa-moon"></i> </div>
      </header>
      <main>
        <section id="searchSection">
            <div class="search-input-wrapper">
                <input id="searchQuery" type="text" placeholder="Start typing..." />
                <button id="searchBtn">Search</button>
            </div>
        </section>
        <div id="results"></div>
      </main>
      <footer> <!-- ... Footer ... --> </footer>
  </div>

<script>
  const apiKey = 'AIzaSyBad6ylBa2aVEYUfTYCLlxIP8FFFJ8ToAI';
  
  const docHtml = document.documentElement;
  const results = document.getElementById('results');
  const searchBtn = document.getElementById('searchBtn');
  const searchQueryInput = document.getElementById('searchQuery');
  const themeSwitcher = document.getElementById('theme-switcher');

  let loading = false;
  let currentQuery = '';
  let nextPageToken = '';

  function applyTheme(theme) {
      docHtml.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
  }
  themeSwitcher.addEventListener('click', () => applyTheme(docHtml.getAttribute('data-theme') === 'light' ? 'dark' : 'light'));
  applyTheme(localStorage.getItem('theme') || 'light');
  
  async function performSearch(query, append = false) {
    if (loading) return;
    if (!apiKey || apiKey === 'Your_API_Key_Here') {
        showMessage('API Key is required.'); return;
    }
    loading = true;
    searchBtn.disabled = true;
    
    if (!append) {
        showLoader();
        nextPageToken = ''; // Reset token for a new search
    } else {
        const loader = document.createElement('div');
        loader.className = 'loader bottom-loader';
        results.appendChild(loader);
    }
    
    let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&type=video&q=${encodeURIComponent(query)}&key=${apiKey}`;
    if (append && nextPageToken) {
        url += `&pageToken=${nextPageToken}`;
    }

    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (!append) {
            results.innerHTML = '';
        } else {
            const existingLoader = results.querySelector('.bottom-loader');
            if (existingLoader) existingLoader.remove();
        }

        if (data.error) { showMessage('Error fetching results.'); return; }
        
        nextPageToken = data.nextPageToken || null; // Update the token

        if (data.items.length === 0 && !append) {
            showMessage(`No results for "${query}"`);
            return;
        }
        
        // Fetch stats for the new videos
        const videoIds = data.items.map(item => item.id.videoId).join(',');
        const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoIds}&key=${apiKey}`;
        const detailsResponse = await fetch(detailsUrl);
        const detailsData = await detailsResponse.json();
        
        const statsMap = detailsData.items.reduce((map, item) => {
            map[item.id] = item.statistics;
            return map;
        }, {});

        data.items.forEach((video, index) => {
            results.appendChild(createVideoCard(video, index, statsMap[video.id.videoId]));
        });

    } catch (err) {
        if (!append) showMessage('Network error.');
    } finally {
        loading = false;
        searchBtn.disabled = false;
    }
  }

  async function fetchTrending() {
    // This function can remain as it is, as it doesn't need infinite scroll
    if (!apiKey || apiKey === 'Your_API_Key_Here') { showMessage('API Key required.'); return; }
    loading = true; showLoader();
    const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&chart=mostPopular&maxResults=12&regionCode=US&key=${apiKey}`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        results.innerHTML = '';
        if (data.error) { showMessage('Could not fetch trending videos.'); return; }
        data.items.forEach((video, index) => {
            const videoData = { id: { videoId: video.id }, snippet: video.snippet };
            results.appendChild(createVideoCard(videoData, index, video.statistics));
        });
    } catch (err) { showMessage('Network error.'); } finally { loading = false; }
  }

  function createVideoCard(video, index, stats = {}) {
      const div = document.createElement('div');
      div.className = 'video-card';
      div.style.animationDelay = `${index * 80}ms`;
      const viewCount = stats.viewCount ? formatViews(stats.viewCount) : '';
      div.innerHTML = `
        <iframe src="https://www.youtube.com/embed/${video.id.videoId}" loading="lazy" allowfullscreen></iframe>
        <div class="video-card-content">
          <h4>${video.snippet.title}</h4>
          <div class="video-info">
              <span>${video.snippet.channelTitle}</span>
              ${viewCount ? `<span><i class="fas fa-eye"></i> ${viewCount}</span>` : ''}
          </div>
        </div>
      `;
      return div;
  }
  
  function formatViews(count) {
      if (!count) return '';
      if (count >= 1e6) return `${(count / 1e6).toFixed(1)}M`;
      if (count >= 1e3) return `${Math.round(count / 1e3)}K`;
      return count;
  }
  function showMessage(message) { results.innerHTML = `<div class="message">${message}</div>`; }
  function showLoader() { results.innerHTML = '<div class="loader"></div>'; }
  
  document.addEventListener('DOMContentLoaded', fetchTrending);
  
  searchBtn.addEventListener('click', () => {
      currentQuery = searchQueryInput.value.trim();
      if (currentQuery) performSearch(currentQuery, false);
  });
  searchQueryInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); searchBtn.click(); }
  });

  // NEW: Infinite Scroll Event Listener
  window.addEventListener('scroll', () => {
    // Check if user is near the bottom, not loading, and there's a next page
    if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight - 500 && !loading && nextPageToken) {
        performSearch(currentQuery, true); // `true` indicates we are appending results
    }
  });
</script>
</body>
</html>